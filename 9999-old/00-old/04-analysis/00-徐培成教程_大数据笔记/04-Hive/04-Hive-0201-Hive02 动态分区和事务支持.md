## 1ï¼ŒHiveçš„ä½¿ç”¨02

* select * from TBLS \G;  ðŸ˜\Gæ˜¯è¡Œè½¬åˆ—ï¼Œåœ¨æŸ¥çœ‹çš„æ—¶å€™æ¯”è¾ƒæ–¹ä¾¿ä¸€äº›ï¼ŒæŠ€èƒ½+1ï¼›

### 01ï¼Œè‡ªåŠ¨åˆ†åŒº(åŠ¨æ€åˆ†åŒº)ï¼š
  *åœ¨åŠ å…¥çš„æ—¶å€™æ ¹æ®åŠ å…¥æ•°æ®çš„å­—æ®µè‡ªåŠ¨åˆ†åŒºï¼Œè€Œä¸å¿…æŠŠåˆ†åŒºæ•°æ®å®šæ­»ã€‚å¦‚ä¸‹ï¼Œæ¼”ç¤ºä¸€ä¸‹åŠ¨æ€åˆ†åŒº*

  * é¦–å…ˆåˆ›å»ºä¸€ä¸ªæœ‰å¹´ä»½å’Œæœˆä»½çš„è¡¨ï¼Œç”¨ä½œæ•°æ®æ’å…¥çš„å…ƒæ•°æ®
    
```mysql
create table t7 (id int , name string , age int, year string, month string);
```



  * ç„¶åŽæ’å…¥ä¸¤æ¡ä¸åŒå¹´ä»½æˆ–æœˆä»½çš„æ•°æ®å§
    
```mysql
insert into t7 (id, name, age, year, month) values (1, "ivanl0000", 10, 2015, 12);

insert into t7 (id, name, age, year, month) values (2, "ivanl111111", 15, 2016, 11);
```



  * ç„¶åŽæŠŠä¸Šé¢è¡¨ä¸­çš„ä¸¤æ¡æ•°æ®æ’å…¥åˆ°æˆ‘ä»¬ä¹‹å‰å»ºçš„åˆ†åŒºè¡¨t5ä¸­åŽ»ï¼Œå› ä¸ºå¹¶æ²¡æœ‰å¼€å¯åŠ¨æ€åˆ†åŒºï¼Œä¼šæŠ¥é”™ï¼š
    
```mysql
insert into t5 partition (year, month) select id, name, age, year, month from t7;
```



  * ä¸Šé¢çš„æ’å…¥ä¼šæŠ¥é”™, é»˜è®¤ä¸¥æ ¼æ¨¡å¼ï¼Œä¸¥æ ¼æ¨¡å¼åœ¨æ’å…¥æ—¶å€™å¿…é¡»è¦æŒ‡å®šä¸€ä¸ªé™æ€åˆ†åŒºï¼Œæˆ‘ä»¬å…³é—­è¿™ä¸ªä¸¥æ ¼æ¨¡å¼å³å¯ï¼š
    
```java
FAILED: SemanticException [Error 10096]: Dynamic partition strict mode requires at least one static partition column. To turn this off set hive.exec.dynamic.partition.mode=nonstrict
```



  * æ ¹æ®æç¤ºå¯ä»¥çŸ¥é“éœ€è¦è®¾ç½®åˆ†åŒºæ¨¡å¼ä¸ºéžä¸¥æ ¼æ¨¡å¼
    
```mysql
set hive.exec.dynamic.partition.mode=nonstrict
```



  * é‡æ–°æ’å…¥å‘çŽ°okäº†

  

### 02ï¼Œhiveçš„äº‹åŠ¡

*åªæœ‰ç”¨äº‹åŠ¡æ‰èƒ½æ”¯æŒè¡Œçº§æ“ä½œï¼Œæ¯”å¦‚æ›´æ–°ï¼Œåˆ é™¤æŸä¸€è¡Œç­‰ç­‰*

  * ä½¿ç”¨äº‹åŠ¡å¿…é¡»è¦å…ˆé…ç½®å¦‚ä¸‹ï¼š
    ```properties
    1.æ‰€æœ‰äº‹åŠ¡è‡ªåŠ¨æäº¤ã€‚
    2.åªæ”¯æŒorcæ ¼å¼ã€‚
    3.ä½¿ç”¨bucketè¡¨ã€‚ 
    4.é…ç½®hiveå‚æ•°ï¼Œä½¿å…¶æ”¯æŒäº‹åŠ¡ã€‚
    ```

###### æ³¨æ„ï¼šä¸‹é¢å¦‚æžœåªæ˜¯åœ¨å‘½ä»¤è¡Œè®¾ç½®è€Œä¸æ”¹å˜é…ç½®æ–‡ä»¶ï¼Œé‚£ä¹ˆåªä¼šå•æ¬¡æœ‰æ•ˆå“ˆ

```mysql
SET hive.support.concurrency = true;				
SET hive.enforce.bucketing = true;
# ä¸Šé¢ä¼šæŠ¥é”™Query returned non-zero code: 1, cause: hive configuration hive.enforce.bucketing does not exists.ï¼Œå…ˆå¿½ç•¥
SET hive.exec.dynamic.partition.mode = nonstrict;	
SET hive.txn.manager = org.apache.hadoop.hive.ql.lockmgr.DbTxnManager;
SET hive.compactor.initiator.on = true;
SET hive.compactor.worker.threads = 1;
```

  * æ˜¾ç¤ºå½“å‰è¿è¡Œçš„äº‹åŠ¡
    
```mysql
show transactions;
```



* æ›´æ–°æ“ä½œ(é»˜è®¤ä½¿ç”¨äº‹åŠ¡è‡ªåŠ¨æäº¤)

```shell
update t2 set name = 'ivanl001' where id = 2;

# å…¶å®žä¼šæŠ¥é”™ï¼šFAILED: SemanticException [Error 10297]: Attempt to do update or delete on table imdb.t2 that does not use an AcidOutputFormat or is not bucketedï¼Œ å› ä¸ºè¡¨ä¸æ˜¯æ¡¶è¡¨
```



  * æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œéœ€è¦é‡æ–°å»ºç«‹ä¸€ä¸ªæ¡¶è¡¨,ä½†æ˜¯è·Ÿä¹‹å‰ä¸ä¸€æ ·ï¼Œè¿™é‡Œéœ€è¦é¢å¤–è®¾ç½®å­˜å‚¨æ ¼å¼ä¸ºorc
    
```mysql
create table t8 (id int, name string, age int) clustered by (id) into 3 buckets row format delimited fields terminated by ',' stored as orc;
```



  * å› ä¸ºloadæ˜¯æ²¡åŠžæ³•å®Œæˆåˆ†æ¡¶æ“ä½œçš„ï¼Œ æ‰€ä»¥è¿˜æ˜¯å’Œä¹‹å‰ä¸€æ ·ï¼Œ ç›´æŽ¥ä»Žt5è¡¨ä¸­æ‹·è´è¿‡æ¥
    
```mysql
insert into t8 select id, name, age from t5;
```



* æ‰§è¡Œæ›´æ–°æ“ä½œ

```mysql
update t8 set name = "ivanl001" where id = 3;

# ä¸è¿‡è¿˜æ˜¯ä¼šæŠ¥é”™ï¼š FAILED: SemanticException [Error 10122]: Bucketized tables do not support INSERT INTO: Table: imdb.t8
# æœ€åŽå‘çŽ°æ˜¯æœ‰ä¸€ä¸ªå±žæ€§éœ€è¦åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™æŒ‡å®šï¼Œæ‰€ä»¥æˆ‘ä»¬é‡æ–°åˆ›å»ºè¡¨t9, å…·ä½“å±žæ€§å¦‚ä¸‹
```



  * é‡æ–°åˆ›å»ºæ–°è¡¨t9:éœ€è¦è®¾ç½®å±žæ€§TBLPROPERTIES, æ³¨æ„ï¼šå•è¯åˆ«å†™é”™äº†ï¼Œåƒè¿‡äº
    
```mysql
create table t9 (id int, name string, age int) clustered by (id) into 3 buckets row format delimited fields terminated by ',' stored as orc tblproperties  ('transactional'='true');
```



  * ç„¶åŽé‡æ–°æŠŠæ•°æ®æ‹·è´è¿‡æ¥
    
```mysql
insert into t9 select id, name, age from t5;
```



  * æ‰§è¡Œæ›´æ–°æ“ä½œ
    
```mysql
update t9 set name = "ivanl001" where id = 3;
```



  * è¿™æ¬¡å°±okå•¦ã€‚å˜¿å˜¿ðŸ˜



## 03ï¼Œgroup by

> group by æ˜¯å¯ä»¥åŽ»é‡çš„ï¼Œåœ¨å…ƒèšçš„æ—¶å€™ç»å¸¸è¿™ä¹ˆç”¨ï¼Œå¤§å®¶åº”è¯¥éƒ½æ˜¯è¿™ä¹ˆç”¨çš„

*æ³¨æ„ï¼šåˆ†ç»„èšåˆçš„è¯ï¼Œselectçš„ä¿¡æ¯åªèƒ½æ˜¯ç»„çš„ä¿¡æ¯ï¼Œè€Œä¸èƒ½æ˜¯æ¯ä¸€æ¡çš„ä¿¡æ¯äº†ï¼Œ æ¯”å¦‚è¯´æŒ‰ç…§ç”¨æˆ·åˆ†ç»„ï¼Œé‚£ä¹ˆèƒ½æŸ¥å‡ºæ¥çš„è‚¯å®šæ˜¯è¿™ä¸ªç”¨æˆ·çš„æ¯”å¦‚è¯´è®¢å•æ•°é‡ï¼Œ è®¢å•æ€»é‡‘é¢ç­‰ç­‰ï¼Œè€Œä¸èƒ½æ˜¯å…·ä½“è®¢å•ç­‰ä¿¡æ¯*

```mysql
select id, name, price , cid from orders group by cid;
# æ‰€ä»¥è¿™ä¸ªä¼šç›´æŽ¥æŠ¥é”™ï¼šFAILED: SemanticException [Error 10025]: Line 1:7 Expression not in GROUP BY key 'id'
# è¿™æ ·æ˜¯å¯ä»¥çš„
select count(*), sum(price), cid from orders group by cid;
# åˆ†ç»„ä¹‹åŽå†è¿›è¡Œæ¡ä»¶ç­›é€‰
select count(*), sum(price) as s, cid from orders group by cid having cid > 30;

```

